<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="refresh" content="1">
	<title>Enigma</title>
</head>
<body>


<script type="text/javascript">
	
// Plugboard Task 2
function isLetter(c) {
	let x = c.match(/[a-z]/i);
	if ( x !== null) {
		return x[0].toUpperCase();
	}
  return x;
}

function plugboard(c) {
	let configuration = undefined;
	//let configuration = ["RY", "BU", "AS", "FZ"]; 
	// empty (undefined), ["RY", "BU", "AS", "FZ"] (max 10)
	if (configuration !== undefined) {
		for (let i =0; i<configuration.length; i++) {
			if (c == configuration[i][0]) { 
				 return configuration[i][1]; 
			}
			if (c == configuration[i][1]) { 
				 return configuration[i][0]; 
			} 
		}
	}
	return c;
}

function indexViaAZ(c) {
	let az = "ABCDEFGHIGKLMNOPQRSTUVWXYZ";
	return az.indexOf(c);
}

function rotor(prev, offset, setting, notch, order) {
	// prev {c : letter, notch_action : boolean}
	// offset number [1 ~ 26]
	// setting string "ABCDEFGHIGKLMNOPQRSTUVWXYZ" or another permutation
	// notch string "Q" 
	// order flag 1 -> forward, -1 -> reverse

	// prepare first time when offset is initial set
	
	// let roll = offset - 1;
	// let part = setting.substr(0, roll);
	// setting = setting.slice(roll, setting[setting.length]);
	// setting = setting.concat(part);

	let action = false, x;

	// forward 
	if(order === 1) {
		if(prev["notch_action"]) {
			offset++;
			let first = setting[0];
			setting = setting.slice(1);
			setting = setting.concat(first);
		}

		if (offset > setting.length) {
			offset = offset % setting.length;
			if (offset == 0) { offset = 1; }  
		}

		// index of letter via alphabet order
		let n = indexViaAZ(prev['c']);

		action = false;
		x = setting[n]; // index of array start from 0
		if(setting[offset] == notch) {
			action = true;
		}
	}

	// reverse
	if(order === -1) {
		// index of letter via alphabet order
		let n = indexViaAZ(prev['c']);

		action = false;
		x = setting[n]; // index of array start from 0
	}
	
	return {c : x, notch_action : action};
}

function reflector(prev, setting) {
	// c letter
	// settring string permutation
	let n = indexViaAZ(prev['c']);
	return {c : setting[n], notch_action : false};
}

console.log(
	reflector(
		rotor(
			rotor( 
				rotor(
					{c : plugboard(isLetter('a')),  notch_action: true}, 1, "EKMFLGDQVZNTOWYHXUSPAIBRCJ", 'R',1
					),
				1, "AJDKSIRUXBLHWTMCQGZNPYFVOE", 'F',1),
			1, "BDFHJLCPRTXVZNYEIWGAKMUSQO", 'W',1),
		"YRUHQSLDPXNGOKMIEBFZCWVJAT"
		)
	);

</script>

</body>
</html>