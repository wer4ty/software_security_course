<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<!--<meta http-equiv="refresh" content="1">-->
	<title>Enigma</title>
	    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery-ui.js" type="text/javascript"></script>
</head>
<body>



<div class="container">
	<div class="row">
		<div class="col-lg-3">

		<h3>Input letter</h3>
		 <input class="form-control" id="plainttext">

		 <h3>Cifer letter</h3>
		 <input disabled="" class="form-control" id="cifertext">

		 <h3>Message</h3>
		 <textarea readonly="true" class="form-control" id="message" rows="3"></textarea>
		 <button class="clear_btn btn btn-primary">Clear</button>

		 </div>

	<!--	 <div class="col-lg-9">

			<table id="table_dynamic" class="table">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Use</th>
      <th scope="col">Ring Setting</th>
      <th scope="col">ABCDEFGHIJKLMNOPQRSTUVWXYZ</th>
      <th scope="col">Turnover notch</th>
      
    </tr>
  </thead>
  <tbody>
    <tr id="r1" class="highlight">
      <th scope="row">I</th>
      <td><input type="checkbox" class="ch_box" checked="true"></td>
      <td><span class="offset_enigma">1</span>
      <button class="left_off btn btn-primary"><</button> <button class="right_off btn btn-primary">></button></td>
      <td><b>E</b>KMFLGDQVZNTOWYHXUSPAIBRCJ</td>
      <td>Q -> R</td>
    </tr>
    <tr id="r2" class="highlight">
      <th scope="row">II</th>
      <td><input type="checkbox" class="ch_box" checked="true"></td>
      <td><span class="offset_enigma">1</span>
      <button class="left_off btn btn-primary"><</button> <button class="right_off btn btn-primary">></button></td>
      <td><b>A</b>JDKSIRUXBLHWTMCQGZNPYFVOE</td>
      <td>E -> F</td>
    </tr>
    <tr id="r3" class="highlight">
      <th scope="row">III</th>
      <td><input type="checkbox" class="ch_box" checked="true"></td>
      <td><span class="offset_enigma">1</span>
      <button class="left_off btn btn-primary"><</button> <button class="right_off btn btn-primary">></button></td>
      <td><b>B</b>DFHJLCPRTXVZNYEIWGAKMUSQO</td>
      <td>V -> W</td>
    </tr>
    <tr id="r4">
      <th scope="row">IV</th>
      <td><input type="checkbox" class="ch_box"></td>
      <td><span class="offset_enigma">1</span>
      <button class="left_off btn btn-primary"><</button> <button class="right_off btn btn-primary">></button></td>
      <td><b>E</b>SOVPZJAYQUIRHXLNFTGKDCMWB</td>
      <td>J -> K</td>
    </tr>
    <tr id="r5">
      <th scope="row">V</th>
      <td><input type="checkbox" class="ch_box"></td>
      <td><span class="offset_enigma">1</span>
      <button class="left_off btn btn-primary"><</button> <button class="right_off btn btn-primary">></button></td>
      <td><b>V</b>ZBRGITYUPSDNHLXAWMJQOFECK</td>
      <td>Z -> A</td>
    </tr>

      
  </tbody>
</table> 

		</div> -->
	</div>
</div>

<script type="text/javascript">

class Substitutor {
	constructor() {
		this.baseAZ = " ABCDEFGHIJKLMNOPQRSTUVWXYZ";
	}

	isLetter(c) {
		// return whitespace
		if ((c == ' ') || (c == '\t') || (c == '\n')) return c; 
		// check if letter: true => return upper case letter
		let x = c.match(/[a-z]/i);
		if ( x !== null) {
			return x[0].toUpperCase();
		}
		// false return undefined
	  return x;
	}

	indexViaAZ(c) {
		if (c !== undefined) 
	 	return this.baseAZ.indexOf(c.toUpperCase()); 
	}

	circular_shift(ind) {
		if (ind > 26) { ind = ind - 26;}
		if(ind < 1) { ind = 26 - Math.abs(ind); }
		return ind;
	}
}	

class Translator extends Substitutor {
	constructor(az){
		super();
		this.az = az;
	}

	getAZ() { return this.az; }
	setAz(az) { this.az = az; }

	simple_translate(c) {
		let ind = this.indexViaAZ(c);
		if (this.isLetter(c) === undefined) return;
		else if(ind !== -1 ) return this.az[ind];
		return c;
	}
}

class Plugboard extends Translator {
	constructor(az){
		super(az);
	}

	translate(c) {
		if (this.az === undefined) { return c; }
		let tmp = this.az.split(" ");
		for (let i=0; i<tmp; i++) {
			if (tmp[i][0] === c.toUpperCase()) { return tmp[i][1]; }
			if (tmp[i][1] === c.toUpperCase()) { return tmp[i][0]; }
		}
	}
}

class Reflector extends Translator {
	constructor(az){
		super(az);
	}
}

class Rotor extends Translator {
	constructor(az, setting, offset, notch){
		super(az);
		this.offset = offset;
		this.setting = setting;
		this.notchLetter = notch;
		this.reverseAZ = new Array(26);
		this.reverseAZ[0] = " ";
	}

	getOffset() { return this.offset; }
	getSetting() { return this.setting; }
	getNotchLetter() { return this.notchLetter; }
	getReverse() { return this.reverseAZ; }

	setSetting(s) {this.setting = s; }
	setOffset(off) { this.offset = off; }

	incrementOffset() {
		this.offset++;
		if(this.offset > 26 || this.offset < 1) { this.offset = 1; }
	}

	translate_forward_reverse(c, direction) {

		let i1 = 1; // index to run over A-Z array
		let i2 = 1; // index to run over rotor's array
		
		// base AZ shifts
		i1 = this.indexViaAZ(c) + this.offset; // shift right (via offset)
		i1 = this.circular_shift(i1);
		i1 = i1 - this.setting;	// shift left (via setting)
		i1 = this.circular_shift(i1);

		// forward direction
		if (direction) {
			let l = this.az.charAt(i1);
			i1 = this.baseAZ.indexOf(l);
		}

		// reverse direction
		else {
			let d = this.reverseAZ.join("");
			let l = d.charAt(i1);
			i1 = this.baseAZ.indexOf(l);
		}

		// rotor AZ shifts
		i2 = i1 - this.offset; // shift left (via offset)
		i2 = this.circular_shift(i2);
		i2 = i2 + this.setting;	// shift right (via setting)
		i2 = this.circular_shift(i2); 

		return this.baseAZ.charAt(i2);
	}

	generateReverseAZ() {
		for (let i = 1; i<this.baseAZ.length; i++) {
			let a_ind = this.indexViaAZ(this.baseAZ[i]);
			let a_let = this.az.charAt(a_ind);
			a_ind = this.indexViaAZ(a_let);
			this.reverseAZ[a_ind] = this.baseAZ[i];
		}
 	}


	notch() {
		if (this.indexViaAZ(this.notchLetter) === this.offset) {
			return true;
		}
		return false;
	}
}

class Enigma extends Substitutor {
	constructor(reflector, plugboard, leftRotor, middleRotor, rightRotor) {
	 super(); 
	 this.reflector = reflector;
	 this.plugboard = plugboard;
	 this.leftRotor = leftRotor;
	 this.middleRotor = middleRotor;
	 this.rightRotor = rightRotor;
	}

	notchingCheck() {
	if (this.rightRotor.notch() || this.middleRotor.notch()) {
			if(this.middleRotor.notch()) {
				this.leftRotor.incrementOffset();
			}
			this.middleRotor.incrementOffset();
		}
		this.rightRotor.incrementOffset();
	}

	 encrypt(c) {
		

		let step1 = this.plugboard.translate(c);

		this.notchingCheck();

		this.rightRotor.generateReverseAZ();
		this.middleRotor.generateReverseAZ();
		this.leftRotor.generateReverseAZ();

		let step2 = this.rightRotor.translate_forward_reverse(step1, true);
		let step3 = this.middleRotor.translate_forward_reverse(step2, true);
		let step4 = this.leftRotor.translate_forward_reverse(step3, true);

		let step5 = this.reflector.simple_translate(step4);

		let step6 = this.leftRotor.translate_forward_reverse(step5, false);
		let step7 = this.middleRotor.translate_forward_reverse(step6, false);
		let step8 = this.rightRotor.translate_forward_reverse(step7, false);

		let step9 = this.plugboard.translate(step8);
		return step9;
	}
}

// Testing
let ref = new Reflector(" YRUHQSLDPXNGOKMIEBFZCWVJAT"); // Type B
//let plu = new Plugboard(" SUCDEZGHIJKLMNCPQYATBVWXRF");
let plu = new Plugboard(undefined);

let rotor1 = new Rotor(" EKMFLGDQVZNTOWYHXUSPAIBRCJ", 1, 17, "Q");
let rotor2 = new Rotor(" AJDKSIRUXBLHWTMCQGZNPYFVOE", 1, 5, "E");
let rotor3 = new Rotor(" BDFHJLCPRTXVZNYEIWGAKMUSQO", 1, 22, "V");
let rotor4 = new Rotor(" ESOVPZJAYQUIRHXLNFTGKDCMWB", 1, 1, "J");
let rotor5 = new Rotor(" VZBRGITYUPSDNHLXAWMJQOFECK", 5, 25, "Z");

// reflector, plugboard, leftRotor, middleRotor, rightRotor
let test_machine = new Enigma(ref, plu, rotor1, rotor2, rotor3);

// primitive gui
$(function(){

	$( "#plainttext" ).focus();

	$("#plainttext").keyup(function(){

		let x = $(this).val();
		$("#cifertext").val(test_machine.encrypt(x[x.length-1]));
		$("#plainttext").val(x[x.length-1]);
		$("#message").val($("#message").val().concat($("#cifertext").val()));
		
	});

	$(".clear_btn").click(function(){
		$("#cifertext, #plainttext, #message").val("");
	});
})

</script>

</body>
</html>